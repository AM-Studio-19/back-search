<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ™¨è¿·AM Studio | è£œè‰²æŸ¥è©¢ç³»çµ±</title>
  <!-- å¼•å…¥ Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- å¼•å…¥å­—å‹ -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; background-color: #fcfcfc; }
    /* è‡ªå®šç¾©èƒŒæ™¯ç´‹ç† */
    .bg-pattern {
      background-image: radial-gradient(#ffe4e6 1px, transparent 1px);
      background-size: 20px 20px;
    }
    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 241, 242, 0.5);
    }
    .collapsible-content { 
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
      max-height: 0; 
      overflow: hidden; 
      opacity: 0; 
      transform: translateY(-10px);
    }
    .collapsible-content.expanded { 
      max-height: 1000px; 
      opacity: 1; 
      transform: translateY(0);
    }
    .animate-enter { animation: slideIn 0.5s ease-out forwards; opacity: 0; transform: translateY(20px); }
    @keyframes slideIn { to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body class="bg-pattern min-h-screen text-gray-700">

  <!-- ç½®é ‚æ¨™é¡Œå€ -->
  <div class="sticky top-0 z-50 glass-card border-b border-pink-100 shadow-sm">
    <div class="max-w-xl mx-auto px-4 py-3 flex items-center justify-center">
      <h1 class="text-xl font-bold text-gray-800 tracking-wide">æ™¨è¿· AM Studio</h1>
    </div>
  </div>

  <div class="max-w-xl mx-auto p-4 sm:p-6 pb-20">
    
    <!-- æœå°‹å¡ç‰‡ -->
    <div class="bg-white p-6 rounded-2xl shadow-xl shadow-pink-100/50 mb-8 border border-white">
      <h2 class="text-2xl font-bold text-center mb-1 text-gray-800">éœ§çœ‰éœ§å”‡è£œè‰²åƒ¹æ ¼æŸ¥è©¢</h2>
      <p class="text-center text-gray-400 text-sm mb-6">è¼¸å…¥å§“åæˆ–é›»è©±è™Ÿç¢¼æŸ¥è©¢æ‚¨ç›®å‰çš„è£œè‰²åƒ¹æ ¼</p>
      
      <div class="relative">
        <input type="text" id="queryInput" placeholder="ä¾‹å¦‚ï¼šæ—å°ç¾ æˆ– 0912..." 
               class="w-full p-4 pl-5 rounded-xl bg-gray-50 border border-gray-200 text-lg focus:outline-none focus:ring-2 focus:ring-pink-300 focus:bg-white transition-all placeholder-gray-400"
               onkeydown="if(event.key === 'Enter') searchRecord()">
      </div>

      <button onclick="searchRecord()" id="searchButton" 
              class="w-full mt-4 p-3.5 bg-gradient-to-r from-[#ff99aa] to-[#ff7a8b] hover:from-[#ff889b] hover:to-[#ff6075] text-white font-bold rounded-xl text-lg shadow-lg shadow-pink-200 transition-all transform active:scale-95 flex justify-center items-center">
        <span>ç«‹å³æŸ¥è©¢</span>
        <!-- Loading Icon -->
        <svg id="loadingIndicator" class="hidden animate-spin h-5 w-5 text-white ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
      </button>

      <!-- è¨Šæ¯é¡¯ç¤ºå€ -->
      <div id="messageArea" class="hidden mt-4 text-center p-3 rounded-xl text-sm font-medium animate-pulse"></div>
    </div>

    <!-- çµæœé¡¯ç¤ºå€ -->
    <div id="resultsArea" class="space-y-6"></div>

    <!-- Footer -->
    <footer class="mt-12 text-center text-xs text-gray-400">
      <p>&copy; æ™¨è¿· AM Studio. All rights reserved.</p>
    </footer>
  </div>

<script>
  // é€™æ˜¯æ–°åŠ çš„ï¼šç”¨ä¾†æŠŠé›»è©±è®Šæˆ 0912***789
  function maskPhoneNumber(phone) {
    if (!phone) return '';
    // å¦‚æœé›»è©±å¤ªçŸ­ï¼ˆä¾‹å¦‚å¸‚è©±ï¼‰ï¼Œå°±ä¸éš±è—ï¼Œç›´æ¥é¡¯ç¤º
    if (phone.length < 8) return phone;
    // å–å‰4ç¢¼ + *** + å¾Œ3ç¢¼
    return phone.substring(0, 4) + '***' + phone.substring(phone.length - 3);
  }
  // â—â—â— è«‹åœ¨é€™è£¡å¡«å…¥ä½ çš„ Apps Script ç¶²å€ â—â—â—
  const GAS_API_URL = "https://script.google.com/macros/s/AKfycbx6grwl5DidK6DScAaZLM8udp-Pjn_FrB33bv6ES0JkwAiiIx-xxJHicxANVGH7caSpEg/exec"; 

  function toggleCollapse(btn, contentId) {
    const content = document.getElementById(contentId);
    const isExpanded = content.classList.toggle('expanded');
    const icon = btn.querySelector('.icon-arrow');
    icon.style.transform = isExpanded ? 'rotate(180deg)' : 'rotate(0deg)';
    btn.querySelector('.btn-text').textContent = isExpanded ? 'æ”¶èµ·è©³ç´°åƒ¹ç›®' : 'æŸ¥çœ‹å®Œæ•´åƒ¹ç›®è¡¨';
  }

  function displayMessage(type, content) {
    const msg = document.getElementById('messageArea');
    msg.textContent = content;
    msg.className = `mt-4 text-center p-3 rounded-xl text-sm font-medium ${
      type === 'error' ? 'bg-red-50 text-red-600 border border-red-100' : 
      type === 'success' ? 'bg-green-50 text-green-600 border border-green-100' : 'bg-gray-100 text-gray-600'
    }`;
    msg.classList.remove('hidden', 'animate-pulse');
  }

  function checkIsExpired(dateStr) {
    if (!dateStr) return false;
    const target = new Date(dateStr);
    const today = new Date();
    today.setHours(0,0,0,0);
    return today > target;
  }

 function getPriceCardHtml(info, useOrangeTheme) {
    if (!info) return '';
    const dateText = (info.dateRange || '').replace(/ã€.*?ã€‘/g,'');
    let priceText = info.price === 0 ? 'å…è²»' : (info.price ? `NT$ ${info.price}` : 'è«‹æ´½è©¢');
    
    // æ¨£å¼é‚è¼¯
    let themeClass = 'bg-gradient-to-br from-pink-50 to-white border-pink-200 text-pink-900';
    let badgeClass = 'bg-pink-500';

    if (info.price === 0) {
      themeClass = 'bg-gradient-to-br from-green-50 to-white border-green-200 text-green-900';
      badgeClass = 'bg-green-600';
    } else if (useOrangeTheme) {
      themeClass = 'bg-gradient-to-br from-orange-50 to-white border-orange-200 text-orange-900';
      badgeClass = 'bg-orange-500';
    }

    return `
      <div class="mt-4 p-4 rounded-xl border ${themeClass} shadow-sm relative overflow-hidden">
        <div class="absolute top-0 right-0 -mt-2 -mr-2 w-16 h-16 bg-white opacity-20 rotate-45 transform"></div>
        <!-- é€™è£¡åŸæœ¬çš„ Current Price å·²ç¶“è¢«ç§»é™¤äº† -->
        <div class="flex justify-between items-end">
           <div>
             <h3 class="text-sm font-bold">ä»Šæ—¥è£œè‰²åƒ¹æ ¼</h3>
             <p class="text-xs mt-1 opacity-80">${dateText}</p>
             ${info.daysRemainingText ? `<p class="text-xs font-bold mt-1 ${info.daysRemainingText.includes('éæœŸ') ? 'text-red-500' : 'text-blue-500'}">${info.daysRemainingText}</p>` : ''}
           </div>
           <span class="px-4 py-1.5 text-lg font-bold text-white rounded-lg shadow-md ${badgeClass}">
             ${priceText}
           </span>
        </div>
      </div>
    `;
  }
  // â—â—â— é€™è£¡æ˜¯ä½ åŸæœ¬çš„ createCard å‡½å¼ï¼Œè«‹ç”¨é€™æ®µæ–°çš„è¦†è“‹æ‰èˆŠçš„ â—â—â—
  function createCard(r, index) {
    const cid = `detail-${index}`;
    const customDate = r.customFreeDate;
    const eyebrowDate = r.eyebrowDiscountDate;
    const type = r.customerType || 'ä¸€èˆ¬å®¢æˆ¶';
    const BOOKING_URL = "https://liff.line.me/1661306685-kQp9pya4"; // ä½ çš„é ç´„ç¶²å€
    
    const isFreeValid = customDate && !checkIsExpired(customDate);
    const isEyebrowValid = eyebrowDate && !checkIsExpired(eyebrowDate);

    // è™•ç†é›»è©±éš±ç¢¼
    const maskedPhone = maskPhoneNumber(r.phone);

    let rangesHtml = (r.touchUpRanges || []).map(t => {
       const isFree = t.price === 0;
       return `
         <div class="flex justify-between items-center py-2 border-b border-dashed border-gray-200 last:border-0">
           <span class="text-sm ${isFree ? 'text-green-600 font-bold' : 'text-gray-600'}">${t.dateRange}</span>
           <span class="text-sm font-bold ${isFree ? 'bg-green-100 text-green-700 px-2 py-0.5 rounded' : 'text-gray-800'}">
             ${t.price === 0 ? 'å…è²»' : (t.price ? '$'+t.price : 'æ´½è©¢')}
           </span>
         </div>`;
    }).join('');

    return `
      <div class="bg-white rounded-2xl p-5 shadow-lg border border-gray-100 animate-enter" style="animation-delay: ${index * 100}ms">
        <!-- æ¨™é ­ -->
        <div class="flex items-center justify-between mb-3">
          <div>
            <h3 class="text-lg font-bold text-gray-800 flex flex-wrap items-center gap-2">
              ${r.name} 
              <!-- é¡¯ç¤ºéš±ç¢¼é›»è©± -->
              ${maskedPhone ? `<span class="text-sm font-normal text-gray-500">(${maskedPhone})</span>` : ''}
            </h3>
            <div class="flex items-center gap-2 mt-1">
                <span class="text-xs font-normal text-white bg-gray-400 px-2 py-0.5 rounded-full">${type}</span>
                <p class="text-sm text-pink-500 font-medium">${r.service}</p>
            </div>
          </div>
          <div class="text-right">
             <p class="text-xs text-gray-400">ä¸Šæ¬¡é ç´„</p>
             <p class="text-sm font-bold text-gray-600">${r.lastDate || 'ç„¡'}</p>
          </div>
        </div>

        <!-- ç‰¹æ®Šå¡ç‰‡å€ -->
        ${isFreeValid ? `
          <div class="mb-3 bg-green-50 border border-green-200 rounded-lg p-3 flex items-center gap-3">
            <div class="bg-green-100 p-2 rounded-full text-green-600">ğŸ</div>
            <div>
              <p class="text-xs text-green-800 font-bold">å…è²»è£œè‰²åˆ°æœŸæ—¥</p>
              <p class="text-base font-black text-green-700">${customDate}</p>
            </div>
          </div>
        ` : ''}

        ${isEyebrowValid ? `
          <div class="mb-3 bg-orange-50 border border-orange-200 rounded-lg p-3 flex items-center gap-3">
            <div class="bg-orange-100 p-2 rounded-full text-orange-600">ğŸ”¥</div>
            <div>
              <p class="text-xs text-orange-800 font-bold">é¦–æ¬¡è£œè‰²å„ªæƒ æœŸé™</p>
              <p class="text-base font-black text-orange-700">${eyebrowDate}</p>
            </div>
          </div>
        ` : ''}

        <!-- ç›®å‰åƒ¹æ ¼ -->
        ${getPriceCardHtml(r.currentPriceInfo, isEyebrowValid)}

        <a href="${BOOKING_URL}" class="block mt-4 w-full py-3 bg-[#06c755] hover:bg-[#05b34c] text-white font-bold rounded-xl text-center shadow-md transition flex justify-center items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
          ç«‹å³å‰å¾€é ç´„
        </a>

        <div class="mt-4">
          <button onclick="toggleCollapse(this, '${cid}')" class="w-full flex items-center justify-center gap-2 text-sm text-gray-400 hover:text-pink-500 transition-colors py-2">
            <span class="btn-text">æŸ¥çœ‹å®Œæ•´åƒ¹ç›®è¡¨</span>
            <svg class="icon-arrow w-4 h-4 transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
          </button>
          
          <div id="${cid}" class="collapsible-content bg-gray-50 rounded-xl px-4 mt-2">
            <div class="py-4 space-y-2">
              ${r.specialReminder ? `<div class="bg-yellow-50 text-yellow-800 text-xs p-2 rounded mb-3">ğŸ’¡ ${r.specialReminder}</div>` : ''}
              ${rangesHtml}
              <p class="text-[10px] text-gray-400 text-center mt-2 pt-2 border-t border-gray-200">ç³»çµ±è©¦ç®—åƒ…ä¾›åƒè€ƒï¼Œå¯¦éš›è²»ç”¨ä»¥ç¾å ´ç‹€æ³ç‚ºæº–</p>
            </div>
          </div>
        </div>
      </div>
    `;
  }
  function searchRecord() {
    const q = document.getElementById('queryInput').value.trim();
    if (!q) return displayMessage('error', 'è«‹è¼¸å…¥å§“åæˆ–é›»è©±');
    
    // UI é‡è¨­
    const btn = document.getElementById('searchButton');
    const loading = document.getElementById('loadingIndicator');
    const msgArea = document.getElementById('messageArea');
    const resultsArea = document.getElementById('resultsArea');
    
    btn.disabled = true;
    btn.classList.add('opacity-75');
    loading.classList.remove('hidden');
    msgArea.classList.add('hidden');
    resultsArea.innerHTML = '';

    // ä½¿ç”¨ Fetch å‘¼å« GAS
    fetch(`${GAS_API_URL}?q=${encodeURIComponent(q)}`)
      .then(response => response.json())
      .then(res => {
        if (res.error) {
          displayMessage('error', res.error);
        } else if (res.message) {
          displayMessage('info', res.message);
        } else if (res.data && res.data.length > 0) {
          displayMessage('success', `æŸ¥è©¢æˆåŠŸï¼šæ‰¾åˆ° ${res.data.length} ç­†è³‡æ–™`);
          resultsArea.innerHTML = res.data.map((r, i) => createCard(r, i)).join('');
        } else {
          displayMessage('info', 'æŸ¥ç„¡è³‡æ–™');
        }
      })
      .catch(err => {
        console.error(err);
        displayMessage('error', 'é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      })
      .finally(() => {
        btn.disabled = false;
        btn.classList.remove('opacity-75');
        loading.classList.add('hidden');
      });
  }
</script>
</body>
</html>
